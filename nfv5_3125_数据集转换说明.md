# nfv5_3125 数据集转换说明

## 数据集概述

**nfv5_3125** 是一个营养标签OCR数据集，包含食品包装上的营养信息标注。数据集原始格式为JSON，已成功转换为InstructOCR项目所需的CSV格式。

## 原始数据格式

### 文件结构
```
nfv5_3125/
├── train.txt          # 训练集标注文件（JSON格式，每行一个JSON对象）
├── test.txt           # 测试集标注文件（JSON格式，每行一个JSON对象）
├── image_files/       # 图像文件目录
├── dict.json          # 字符字典
└── class_list.json    # 类别列表
```

### JSON数据结构
每行包含一个JSON对象，结构如下：
```json
{
  "file_name": "image_files/UK_562.jpg",
  "height": 图像高度,
  "width": 图像宽度,
  "annotations": [
    {
      "polygon": [x1, y1, x2, y2, x3, y3, x4, y4, ...],  # 多边形坐标点
      "text": "NUTRITION INFORMATION",                    # 文本内容
      "entity": ["O", "O"]                              # 实体标签
    }
  ],
  "entity_dict": {                                       # 实体字典
    "CE-P1": "1725kJ / 416kcal",
    "TF-P1": "34.9g"
  }
}
```

## 转换后的CSV格式

### 输出文件
- `nfv5_train.csv` - 训练集（2,250张图像，85,155个标注）
- `nfv5_test.csv` - 测试集（750张图像，25,998个标注）

### CSV格式规范
```
图像文件名<TAB>标注字符串
```

其中标注字符串格式为：
```
x1,y1,x2,y2,x3,y3,x4,y4&rec&文本内容&&tab&&下一个标注...
```

### 转换规则

1. **坐标处理**：
   - 将多边形坐标转换为四边形坐标
   - 如果原始polygon超过8个坐标点，取前4个点
   - 如果少于8个坐标点，进行智能补全
   - 坐标值四舍五入为整数

2. **文本处理**：
   - 直接使用原始text字段
   - 保留所有字符，包括特殊符号和空格

3. **多标注连接**：
   - 使用`&&tab&&`分隔符连接同一图像的多个标注

## 转换示例

### 原始JSON
```json
{
  "file_name": "image_files/UK_562.jpg",
  "annotations": [
    {
      "polygon": [11.3, 33.7, 123.4, 35.1, 248.3, 10.7, 251.3, 30.7, 122.4, 53.1, 11.3, 53.7],
      "text": "NUTRITION INFORMATION"
    },
    {
      "polygon": [105, 109, 156, 110, 155, 126, 105, 126],
      "text": "105kcal"
    }
  ]
}
```

### 转换后CSV
```
image_files/UK_562.jpg	11,34,123,35,248,11,251,31&rec&NUTRITION INFORMATION&&tab&&105,109,156,110,155,126,105,126&rec&105kcal
```

## 使用方法

### 1. 运行转换脚本
```bash
python3 convert_nfv5_to_csv.py
```

### 2. 在InstructOCR中使用

修改训练脚本或配置文件，指定数据集路径：
```python
# 在 ocr_dataset.py 的 build 函数中
if dataset_name == 'nfv5_train':
    img_folder = '/path/to/nfv5_3125/image_files'
    ann_file = '/path/to/nfv5_3125/nfv5_train.csv'
elif dataset_name == 'nfv5_test':
    img_folder = '/path/to/nfv5_3125/image_files'
    ann_file = '/path/to/nfv5_3125/nfv5_test.csv'
```

### 3. 训练命令示例
```bash
python main.py \
    --dataset_name nfv5_train \
    --image_set train \
    --output_dir ./outputs/nfv5_training
```

## 数据集特点

1. **领域特化**：专注于营养标签OCR，包含大量营养成分相关术语
2. **多语言**：包含英文营养标签
3. **复杂布局**：营养标签通常包含表格、列表等复杂布局
4. **实体标注**：包含营养成分的实体识别标注
5. **高质量标注**：坐标精确，文本完整

## 注意事项

1. **坐标系统**：使用图像像素坐标系，原点在左上角
2. **文件路径**：图像文件路径相对于数据集根目录
3. **字符编码**：所有文件使用UTF-8编码
4. **数据完整性**：转换过程中保留了所有有效的标注信息

## 验证方法

### 检查转换结果
```bash
# 查看文件行数
wc -l nfv5_train.csv nfv5_test.csv

# 查看前几行内容
head -3 nfv5_train.csv

# 检查文件大小
ls -lh nfv5_*.csv
```

### 数据统计
- **训练集**：2,250张图像，85,155个文本区域
- **测试集**：750张图像，25,998个文本区域
- **总计**：3,000张图像，111,153个文本区域

## 转换脚本说明

转换脚本 `convert_nfv5_to_csv.py` 的主要功能：

1. **智能坐标处理**：自动处理各种polygon格式
2. **错误处理**：跳过无效数据，记录处理日志
3. **格式标准化**：确保输出符合InstructOCR要求
4. **批量处理**：同时处理训练集和测试集

现在nfv5_3125数据集已成功转换为InstructOCR项目可直接使用的CSV格式！